name: Android Build

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating a Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x gradlew

      # --- DEBUG BUILD (Artifact only) ---
      - name: Build Android Debug
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: ./gradlew assembleDebug

      - name: Upload Debug Artifact
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          # Only upload signed apks if any filters are needed, but debug is usually signed by default

      # --- RELEASE BUILD (GitHub Release Asset) ---
      - name: Decode Keystore
        if: startsWith(github.ref, 'refs/tags/')
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/release.keystore

      - name: Build Android Release
        if: startsWith(github.ref, 'refs/tags/')
        run: ./gradlew assembleRelease -Ptag_name=${{ github.ref_name }}
        env:
          NODE_ENV: production
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Create GitHub Release and Upload Assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          # EXPLICIT FILTER: Only files ending in .apk but NOT containing 'unsigned'
          files: |
            app/build/outputs/apk/release/*.apk
            !app/build/outputs/apk/release/*unsigned.apk
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
          name: Release ${{ github.ref_name }}
          body: |
            ### üöÄ The Native Reboot (v0.1.0-beta)
            We have completely rebuilt AudioBookPlayer from the ground up as a high-performance native Android application.
            
            #### ‚ú® Key Highlights:
            - **Premium Glass Theme:** A custom "Liquid Glass" engine with AGSL shaders (Refraction, Dispersion, and Noise).
            - **Native Kotlin + Compose:** Maximum fluidity and industry-standard architecture (MVVM + Hilt).
            - **Media3 Engine:** Rock-solid audio playback using the latest Google Media3 (ExoPlayer) libraries.
            - **Optimized Assets:** This release includes specialized APKs for different architectures to ensure the smallest footprint on your device.
            
            #### üõ†Ô∏è Features:
            - Automated Library Scanning.
            - Reliable Playback Persistence (Room DB).
            - Shifting Gradient Backgrounds.
            - Theme Switching (Glass vs. Material 3).
            - Interactive Live Notifications.
            
            *Download the APK corresponding to your device architecture (usually arm64-v8a) or the universal version below.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
